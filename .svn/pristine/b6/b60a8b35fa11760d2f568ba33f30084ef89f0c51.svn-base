//
//  PurchaseViewController.m
//  charmgram
//
//  Created by Rui Wei on 13-5-12.
//  Copyright (c) 2013年 Flashfresh. All rights reserved.
//

#import "PurchaseViewController.h"

@interface PurchaseViewController ()

@end

@implementation PurchaseViewController
 
- (void)viewDidLoad
{
    [super viewDidLoad];
	UIView *topbar=[[UIView alloc] initWithFrame:CGRectMake(0, 0, kDeviceWidth, kTopbarHeight)];
    topbar.backgroundColor=[UIColor colorWithPatternImage:[UIImage imageNamed:@"header_base"]];
    [self.view addSubview:topbar];
    
    UILabel* lblTitle=[[UILabel alloc] initWithFrame:CGRectMake(0, 10, kDeviceWidth, 24)];
    lblTitle.textAlignment=UITextAlignmentCenter;
    lblTitle.backgroundColor=[UIColor clearColor];
    lblTitle.textColor=[UIColor whiteColor];
    lblTitle.text=@"购买靓点";
    lblTitle.font=[UIFont boldSystemFontOfSize:20.0];
    [topbar addSubview:lblTitle];
	
	UIButton *btnCancel=[UIButton buttonWithType:UIButtonTypeCustom];
    [btnCancel setBackgroundImage:[UIImage imageNamed:@"header_btn_back_off"] forState:UIControlStateNormal];
    [btnCancel setBackgroundImage:[UIImage imageNamed:@"header_btn_back_on"] forState:UIControlStateHighlighted];
    btnCancel.frame=CGRectMake(8, 0, 54,44);
    [btnCancel addTarget:self action:@selector(clickBack) forControlEvents:UIControlEventTouchUpInside];
    [topbar addSubview:btnCancel];
	
	tbMain=[[UITableView alloc] initWithFrame:CGRectMake(0, kTopbarHeight, kDeviceWidth, kDeviceHeight-kTopbarHeight-20) style:UITableViewStyleGrouped];
	tbMain.backgroundColor=[UIColor whiteColor];
	tbMain.backgroundView=nil;
	tbMain.dataSource=self;
	tbMain.delegate=self;
	[self.view addSubview:tbMain];
	
	[self initArray];
}

-(void)initArray{
	arrItem=[[NSMutableArray alloc] initWithCapacity:0];
	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"1靓点",@"title",@"0.01", @"price",nil]];
	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"100靓点",@"title",@"1.00", @"price",nil]];
	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"500靓点",@"title",@"5.00", @"price",nil]];
	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"1000靓点",@"title",@"10.00", @"price",nil]];
	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"5000靓点",@"title",@"50.00", @"price",nil]];
	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"10000靓点",@"title",@"100.00", @"price",nil]];
//	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"7000靓点(赠1000)",@"title",@"60.00", @"price",nil]];
//	[arrItem addObject:[NSDictionary dictionaryWithObjectsAndKeys:@"10000靓点(赠1200)",@"title",@"88.00", @"price",nil]]; 
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning]; 
}

#pragma mark - Click Event
-(void)clickBack{
	[self.navigationController popViewControllerAnimated:YES];
}

#pragma mark - Tableview Delegate
-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{
	return 54.0;
}

- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section{
	return [arrItem count];
}

-(UITableViewCell*) tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath{
	static NSString* cellId=@"mycell";
	UITableViewCell *cell=[tableView dequeueReusableCellWithIdentifier:cellId];
	if (!cell) {
		cell=[[UITableViewCell alloc] initWithStyle:UITableViewCellStyleSubtitle reuseIdentifier:cellId];
	}
	cell.selectionStyle=UITableViewCellSelectionStyleGray ;
	int row=indexPath.row;
	NSDictionary* dict=(NSDictionary*)[arrItem objectAtIndex:row];
	cell.textLabel.text=[NSString stringWithFormat:@" %@",  [dict objectForKey:@"title"]];
	cell.textLabel.textAlignment=UITextAlignmentLeft;
	cell.textLabel.font=[UIFont systemFontOfSize:16.0];
	cell.detailTextLabel.text=[NSString stringWithFormat:@" ￥%@",  [dict objectForKey:@"price"]];
	cell.detailTextLabel.textAlignment=UITextAlignmentLeft;
	cell.detailTextLabel.font=[UIFont systemFontOfSize:15.0];
	cell.detailTextLabel.textColor=[UIColor colorWithWhite:0.35 alpha:1.0];
	cell.accessoryType=UITableViewCellAccessoryDisclosureIndicator;
	 
	return cell;
}

-(void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath{
	[tableView deselectRowAtIndexPath:indexPath animated:YES];
	int row=indexPath.row;
	

    [self orderIdMake:row];
	//    [self presentViewController:controller animated:YES completion:nil];
//    [self performSelector:@selector(gotoDone) withObject:nil afterDelay:1.0];
 
}
-(void )orderIdMake:(int)index{
    NSDictionary* dict=(NSDictionary*)[arrItem objectAtIndex:index];
    NSString * fee = [dict objectForKey:@"price"];
    NSString * title = [dict objectForKey:@"title"];
    NSString *strcoin = [title stringByReplacingOccurrencesOfString:@"靓点" withString:@""];
    ASIFormDataRequest* asirequest=[[ASIFormDataRequest alloc] initWithURL:[NSURL URLWithString:UrlBase]];
	[asirequest setPostValue:METHOD_GETUNIQUEID forKey:@"method"];
	[asirequest setPostValue:[NSString stringWithFormat:@"%d", [AppHelper getIntConfig:confUserId]] forKey:@"userid"];
	[asirequest setPostValue:[AppHelper getStringConfig:confUserToken] forKey:@"token"];
    [asirequest setPostValue:fee forKey:@"fee"];
    [asirequest setPostValue:strcoin forKey:@"coin"];
    __weak ASIHTTPRequest *wrequest=asirequest;
    asirequest.timeOutSeconds=90;
    //    DLog(@"%@",dictInput);
	NSLog(@"userid=%d&token=%@&fee=%@&coin=%@",[AppHelper getIntConfig:confUserId],[AppHelper getStringConfig:confUserToken],fee,strcoin);
    [asirequest setCompletionBlock:^{
        NSString* respString=[wrequest responseString];
        NSLog(@"respString===%@",respString);
        id JSON=[respString objectFromJSONString];
        int code=[AppHelper getIntFromDictionary:JSON key:@"code"];
        NSString* msg=[AppHelper getStringFromDictionary:JSON key:@"message"];
        if (code==REQUEST_CODE_SUCCESS) {
            id data=[JSON objectForKey:@"data"];
			NSLog(@"data===%@",data);
            
            PaymentViewController *controller = [[PaymentViewController alloc] init];
            
            //    controller.curPray=prayitem;
            controller._strPayName= [dict objectForKey:@"title"];
            controller._strMoney = [dict objectForKey:@"price"];
            controller._strDay = @"";
            controller._strAddress = @"";
            controller._strNongli = @"";
            controller._strNo = [NSString stringWithFormat:@"%@",data];
            UINavigationController *navController = [[UINavigationController alloc] initWithRootViewController:controller] ;
            [self presentModalViewController:navController animated:YES];

        }
        else{
            [AppHelper showAlertMessage:msg];
        }
		[AppHelper hideHUD:self.view];
    }];
    [asirequest setFailedBlock:^{
		[AppHelper hideHUD:self.view];
    }];
    [asirequest startAsynchronous];
}
@end
